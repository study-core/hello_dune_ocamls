# PPX é‡å†™å™¨è¯¦è§£

è¿™ä¸ªç›®å½•åŒ…å«äº†å„ç§è‡ªå®šä¹‰ PPX é‡å†™å™¨çš„å®ç°ï¼Œæ¯ä¸ªé‡å†™å™¨æ¼”ç¤ºäº†ä¸åŒç±»å‹çš„ PPX æ‰©å±•ã€‚

## é‡å†™å™¨åˆ—è¡¨

### 1. ppx_debug.ml - %debug æ‰©å±•ï¼ˆè¡¨è¾¾å¼çº§åˆ«ï¼‰

**åŠŸèƒ½**ï¼šä¸ºè¡¨è¾¾å¼æ·»åŠ è°ƒè¯•è¾“å‡ºåŠŸèƒ½

**è¯­æ³•**ï¼š
```ocaml
[%debug expression]
```

**ç¤ºä¾‹**ï¼š
```ocaml
let result = [%debug 1 + 2 + 3]  (* ä¼šæ‰“å°è¡¨è¾¾å¼çš„å€¼ *)
```

**è½¬æ¢ç»“æœ**ï¼š
```ocaml
let result =
  Printf.printf "ğŸ› [DEBUG] è¡¨è¾¾å¼: %s\n" "1 + 2 + 3";
  let result = 1 + 2 + 3 in
  Printf.printf "ğŸ› [DEBUG] ç»“æœ: %s\n" "6";
  result
```

---

### 2. ppx_calc.ml - %calc æ‰©å±•ï¼ˆè¡¨è¾¾å¼çº§åˆ«ï¼‰

**åŠŸèƒ½**ï¼šåœ¨ç¼–è¯‘æ—¶è¿›è¡Œæ•°å­¦è®¡ç®—

**è¯­æ³•**ï¼š
```ocaml
[%calc expression]
```

**ç¤ºä¾‹**ï¼š
```ocaml
let area = [%calc 3.14 * r * r]  (* ç¼–è¯‘æ—¶è®¡ç®— *)
```

**ç”¨é€”**ï¼šé¿å…è¿è¡Œæ—¶è®¡ç®—ï¼Œæå‡æ€§èƒ½

---

### 3. ppx_log.ml - %log æ‰©å±•ï¼ˆè¡¨è¾¾å¼çº§åˆ«ï¼‰

**åŠŸèƒ½**ï¼šä¸ºè¡¨è¾¾å¼æ‰§è¡Œæ·»åŠ æ—¥å¿—è®°å½•

**è¯­æ³•**ï¼š
```ocaml
[%log expression]
```

**ç¤ºä¾‹**ï¼š
```ocaml
let data = [%log load_data_from_file "input.txt"]
```

**è½¬æ¢ç»“æœ**ï¼š
```ocaml
let data =
  Printf.printf "[LOG] Executing expression at %s\n" "file.ml:42";
  let result = load_data_from_file "input.txt" in
  Printf.printf "[LOG] Expression result: %s\n" "<value>";
  result
```

---

### 4. ppx_auto.ml - %%auto æ‰©å±•ï¼ˆç»“æ„é¡¹çº§åˆ«ï¼‰

**åŠŸèƒ½**ï¼šä¸ºç±»å‹å®šä¹‰è‡ªåŠ¨ç”Ÿæˆè¾…åŠ©å‡½æ•°

**è¯­æ³•**ï¼š
```ocaml
[%%auto {
  type color = Red | Green | Blue
  type point = { x : int; y : int }
}]
```

**ç”Ÿæˆçš„ä»£ç **ï¼š
```ocaml
(* ä¸ºå˜ä½“ç±»å‹ç”Ÿæˆ *)
let to_string = function Red -> "Red" | Green -> "Green" | Blue -> "Blue"
let of_string = function "Red" -> Red | "Green" -> Green | "Blue" -> Blue | _ -> failwith "..."

(* ä¸ºè®°å½•ç±»å‹ç”Ÿæˆ *)
let get_x r = r.x
let get_y r = r.y
```

---

### 5. ppx_module_wrapper.ml - %%%module_wrapper æ‰©å±•ï¼ˆæ–‡ä»¶çº§åˆ«ï¼‰

**åŠŸèƒ½**ï¼šå°†æ•´ä¸ªæ–‡ä»¶åŒ…è£…åœ¨æ¨¡å—ä¸­

**è¯­æ³•**ï¼š
```ocaml
[%%%module_wrapper {
  let x = 42
  let y = "hello"
  let add a b = a + b
}]
```

**è½¬æ¢ç»“æœ**ï¼š
```ocaml
module WrappedModule = struct
  let x = 42
  let y = "hello"
  let add a b = a + b
end

open WrappedModule
```

---

### 6. ppx_regex.ml - @regex æ‰©å±•ï¼ˆæ¨¡å¼çº§åˆ«ï¼‰

**åŠŸèƒ½**ï¼šåœ¨æ¨¡å¼åŒ¹é…ä¸­ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼

**è¯­æ³•**ï¼š
```ocaml
match str with
| _ when Str.string_match (Str.regexp pattern) str 0 -> "åŒ¹é…"
```

**æ¦‚å¿µç¤ºä¾‹**ï¼š
```ocaml
match str with
| _ @ regex "^\\d+$" -> "æ•°å­—"
| _ @ regex "^[a-zA-Z]+$" -> "å­—æ¯"
| _ -> "å…¶ä»–"
```

---

### 7. ppx_alias.ml - @@alias æ‰©å±•ï¼ˆç±»å‹çº§åˆ«ï¼‰

**åŠŸèƒ½**ï¼šä¸ºç±»å‹æ·»åŠ åˆ«åå±æ€§

**è¯­æ³•**ï¼š
```ocaml
type person @@ alias "Person" = {
  name : string;
  age : int;
}
```

**ç”¨é€”**ï¼šç±»å‹ç³»ç»Ÿé›†æˆã€å…ƒæ•°æ®è®°å½•

---

### 8. ppx_wrapped.ml - @@@wrapped æ‰©å±•ï¼ˆæ¨¡å—çº§åˆ«ï¼‰

**åŠŸèƒ½**ï¼šä¸ºæ¨¡å—æ·»åŠ åŒ…è£…åŠŸèƒ½

**è¯­æ³•**ï¼š
```ocaml
module Calculator [@@@wrapped] = struct
  let add x y = x + y
end
```

**è½¬æ¢ç»“æœ**ï¼š
```ocaml
module Calculator = struct
  let __wrapped_module = "wrapped"
  let add x y = x + y
end
```

## ç¼–è¯‘å’Œä½¿ç”¨

### æ„å»ºé‡å†™å™¨

```bash
dune build ppxstudy/rewriters
```

### ä½¿ç”¨é‡å†™å™¨

```bash
# ç¼–è¯‘æ—¶ä½¿ç”¨
ocamlc -ppx './ppx_study_rewriters.exe' your_file.ml

# æˆ–åœ¨ dune ä¸­é…ç½®
(preprocess (pps ppx_study_rewriters))
```

## å­¦ä¹ é‡ç‚¹

1. **è¡¨è¾¾å¼çº§åˆ«æ‰©å±•** (`%`)ï¼šå¤„ç†å•ä¸ªè¡¨è¾¾å¼
2. **ç»“æ„é¡¹çº§åˆ«æ‰©å±•** (`%%`)ï¼šå¤„ç†é¡¶å±‚å£°æ˜
3. **æ–‡ä»¶çº§åˆ«æ‰©å±•** (`%%%`)ï¼šå¤„ç†æ•´ä¸ªæ–‡ä»¶
4. **æ¨¡å¼çº§åˆ«æ‰©å±•** (`@`)ï¼šå¢å¼ºæ¨¡å¼åŒ¹é…
5. **ç±»å‹çº§åˆ«æ‰©å±•** (`@@`)ï¼šå¤„ç†ç±»å‹å®šä¹‰
6. **æ¨¡å—çº§åˆ«æ‰©å±•** (`@@@`)ï¼šå¤„ç†æ¨¡å—å®šä¹‰

## å®ç°è¦ç‚¹

- ä½¿ç”¨ `Extension.declare` æ³¨å†Œæ‰©å±•
- æŒ‡å®šæ‰©å±•ä¸Šä¸‹æ–‡ï¼ˆ`Extension.Context.*`ï¼‰
- ä½¿ç”¨ `Ast_pattern` åŒ¹é…è¯­æ³•ç»“æ„
- ä½¿ç”¨ `Ast_helper` æ„é€ æ–°çš„ AST
- ä½¿ç”¨ `metaquot` (`[%expr ...]`) åˆ›å»ºä»£ç æ¨¡æ¿

## @ æ‰©å±•é‡å†™å™¨è¯¦è§£

### ppx_regex.ml - @regex æ‰©å±•
**åŠŸèƒ½**ï¼šåœ¨æ¨¡å¼åŒ¹é…ä¸­ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿›è¡Œå­—ç¬¦ä¸²åŒ¹é…

**å®ç°è¦ç‚¹**ï¼š
- ä½¿ç”¨ `Ast_pattern.(single_expr_payload __)` åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼å‚æ•°
- è½¬æ¢ä¸º `Str.string_match` è°ƒç”¨
- ç”Ÿæˆå¸¦æ¡ä»¶çš„æ¨¡å¼ `Ast_helper.Pat.when_`

### ppx_range.ml - @range æ‰©å±•
**åŠŸèƒ½**ï¼šåœ¨æ¨¡å¼åŒ¹é…ä¸­ä½¿ç”¨æ•°å€¼èŒƒå›´æ£€æŸ¥

**å®ç°è¦ç‚¹**ï¼š
- ä½¿ç”¨ `Ast_pattern.(pair __ __)` åŒ¹é…æœ€å°å€¼å’Œæœ€å¤§å€¼å‚æ•°
- ç”Ÿæˆæ•°å€¼æ¯”è¾ƒæ¡ä»¶ `value >= min && value <= max`
- æ”¯æŒæ•´æ•°å’Œæµ®ç‚¹æ•°èŒƒå›´æ£€æŸ¥

### ppx_is_type.ml - @is_type æ‰©å±•
**åŠŸèƒ½**ï¼šåœ¨æ¨¡å¼åŒ¹é…ä¸­è¿›è¡Œè¿è¡Œæ—¶ç±»å‹æ£€æŸ¥

**å®ç°è¦ç‚¹**ï¼š
- ä½¿ç”¨ `Obj.tag` å’Œ `Obj.repr` è¿›è¡Œè¿è¡Œæ—¶ç±»å‹æ£€æŸ¥
- æ”¯æŒ `int`, `string`, `float`, `bool`, `list` ç­‰åŸºæœ¬ç±»å‹
- æ‰¹é‡æ³¨å†Œå¤šä¸ªç›¸å…³æ‰©å±•

### ppx_valid.ml - @valid æ‰©å±•
**åŠŸèƒ½**ï¼šåœ¨æ¨¡å¼åŒ¹é…ä¸­æ·»åŠ é¢å¤–çš„éªŒè¯æ¡ä»¶

**å®ç°è¦ç‚¹**ï¼š
- ä½¿ç”¨ `Ast_pattern.(single_expr_payload __)` åŒ¹é…éªŒè¯è¡¨è¾¾å¼
- å°†éªŒè¯æ¡ä»¶è½¬æ¢ä¸º `when` å­å¥
- æ”¯æŒä»»æ„å¤æ‚çš„å¸ƒå°”è¡¨è¾¾å¼ä½œä¸ºéªŒè¯æ¡ä»¶

### ppx_formats.ml - æ•°æ®æ ¼å¼è¯†åˆ«æ‰©å±•
**åŠŸèƒ½**ï¼šè‡ªåŠ¨è¯†åˆ« JSONã€XMLã€YAML ç­‰æ•°æ®æ ¼å¼

**å®ç°è¦ç‚¹**ï¼š
- å®ç°ç®€å•çš„æ ¼å¼æ£€æµ‹å‡½æ•°
- æ‰¹é‡åˆ›å»º `json`, `xml`, `yaml` ä¸‰ä¸ªæ‰©å±•
- ç”¨äºæ•°æ®æ ¼å¼çš„è‡ªåŠ¨è¯†åˆ«å’Œè·¯ç”±

## @@@ æ‰©å±•é‡å†™å™¨è¯¦è§£

### ppx_wrapped.ml - @@@wrapped æ‰©å±•
**åŠŸèƒ½**ï¼šä¸ºæ¨¡å—æ·»åŠ åŒ…è£…ç»“æ„å’Œæ ‡è¯†ç¬¦

**å®ç°è¦ç‚¹**ï¼š
- ä½¿ç”¨ `Extension.Context.module_expr` å¤„ç†æ¨¡å—è¡¨è¾¾å¼
- åŒ¹é… `Pmod_structure` ç»“æ„æ¨¡å—
- åœ¨æ¨¡å—å¼€å¤´æ·»åŠ åŒ…è£…æ ‡è¯†
- ä¿æŒåŸæœ‰æ¨¡å—åŠŸèƒ½ä¸å˜

### ppx_timed.ml - @@@timed æ‰©å±•
**åŠŸèƒ½**ï¼šä¸ºæ¨¡å—ä¸­çš„æ‰€æœ‰å‡½æ•°æ·»åŠ æ‰§è¡Œæ—¶é—´æµ‹é‡

**å®ç°è¦ç‚¹**ï¼š
- éå†æ¨¡å—çš„æ‰€æœ‰å€¼ç»‘å®š
- ä¸ºæ¯ä¸ªå‡½æ•°åŒ…è£…æ‰§è¡Œæ—¶é—´æµ‹é‡é€»è¾‘
- ä½¿ç”¨ `Unix.gettimeofday` è®¡ç®—æ—¶é—´å·®
- å¤„ç†é€’å½’å‡½æ•°å’Œå¼‚å¸¸æƒ…å†µ

### ppx_logged.ml - @@@logged æ‰©å±•
**åŠŸèƒ½**ï¼šä¸ºæ¨¡å—ä¸­çš„æ‰€æœ‰å‡½æ•°æ·»åŠ è°ƒç”¨æ—¥å¿—è®°å½•

**å®ç°è¦ç‚¹**ï¼š
- ä¸ºå‡½æ•°è°ƒç”¨å’Œè¿”å›æ·»åŠ æ—¥å¿—è¾“å‡º
- å¤„ç†å¼‚å¸¸æƒ…å†µçš„æ—¥å¿—è®°å½•
- ä½¿ç”¨ `Printf.printf` è¿›è¡Œæ—¥å¿—è¾“å‡º
- ä¿æŒå‡½æ•°çš„åŸæœ‰è¿”å›å€¼

### ppx_cached.ml - @@@cached æ‰©å±•
**åŠŸèƒ½**ï¼šä¸ºæ¨¡å—ä¸­çš„çº¯å‡½æ•°æ·»åŠ è‡ªåŠ¨ç»“æœç¼“å­˜

**å®ç°è¦ç‚¹**ï¼š
- ä¸ºæ¯ä¸ªå‡½æ•°åˆ›å»ºå¯¹åº”çš„ç¼“å­˜å“ˆå¸Œè¡¨
- åœ¨å‡½æ•°è°ƒç”¨å‰æ£€æŸ¥ç¼“å­˜
- ç¼“å­˜æœªå‘½ä¸­æ—¶æ‰§è¡Œè®¡ç®—å¹¶å­˜å‚¨ç»“æœ
- ä½¿ç”¨ç®€åŒ–çš„å‚æ•°ä½œä¸ºç¼“å­˜é”®
